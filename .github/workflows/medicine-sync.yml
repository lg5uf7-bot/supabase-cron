name: Medicine Daily Sync

on:
  schedule:
    - cron: '0 2 * * *'  # Runs every day at 2:00 AM UTC
  workflow_dispatch:

jobs:
  update-medicines:
    runs-on: ubuntu-latest

    steps:
      - name: Call Supabase Edge Function
        id: call_edge
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "Calling Edge Function..."
          
          response=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "$SUPABASE_URL" \
            -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{}')

          echo "HTTP Status: $response"
          cat response.json

          # Output status for conditional steps
          echo "status=$response" >> $GITHUB_OUTPUT

      - name: Send Telegram Success
        if: steps.call_edge.outputs.status == '200'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"✅ GitHub Cron executed successfully.\"}"

      - name: Send Telegram Failure
        if: steps.call_edge.outputs.status != '200'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"$TELEGRAM_CHAT_ID\",\"text\":\"❌ GitHub Cron failed to call Edge Function.\"}"
